<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>ArTales - Create Post</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&amp;family=Montserrat:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
        --background: #fdfcf9;
        --text-primary: #38342e;
        --text-secondary: #7a756e;
        --accent-burnt-umber: #8a3b29;
        --accent-sage: #8f9779;
        --accent-golden-hour: #f9ad1f;
        --border-color: #e6e2db;
      }
      body {
        font-family: "Montserrat", sans-serif;
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: "Lora", serif;
      }
      .icon-hand-drawn {
        stroke-width: 1.5;
        transform: rotate(-1deg);
      }
    </style>
</head>

<body class="bg-[var(--background)] text-[var(--text-primary)]">
    <div class="flex flex-col min-h-screen">
        <header class="border-b border-[var(--border-color)] px-10 py-4">
            <div class="container mx-auto flex items-center justify-between">
                <a class="flex items-center gap-3" href="/">
                    <svg class="h-6 w-6 text-[var(--accent-burnt-umber)] icon-hand-drawn" fill="none" height="24"
                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"
                        width="24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                    </svg>
                    <h1 class="text-xl font-bold">ArTales</h1>
                </a>
                <nav class="hidden md:flex items-center gap-8 text-sm font-medium text-[var(--text-secondary)]">
                    <a class="hover:text-[var(--text-primary)] transition-colors" href="/">Home</a>
                    <a class="hover:text-[var(--text-primary)] transition-colors" href="/profile.html">Profile</a>
                </nav>
                <div class="flex items-center gap-4">
                    <button id="logout-btn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors hidden">
                        <span class="material-symbols-outlined icon-hand-drawn">logout</span>
                    </button>
                </div>
            </div>
        </header>
        <main class="flex-grow flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
            <div class="w-full max-w-2xl text-center">
                <h2 class="text-3xl font-bold tracking-tight mb-4">Create Your ArTale</h2>
                <p class="text-[var(--text-secondary)] mb-10">Upload your artwork and let AI craft a beautiful story with audio narration.</p>
                <form id="create-form" enctype="multipart/form-data">
                    <div class="relative border-2 border-dashed border-[var(--border-color)] rounded-xl p-8 sm:p-12 lg:p-16 transition-colors duration-300 ease-in-out hover:border-[var(--accent-sage)] hover:bg-white/50">
                        <div class="flex flex-col items-center justify-center space-y-4">
                            <svg class="w-16 h-16 text-[var(--accent-sage)] icon-hand-drawn" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" x2="12" y1="3" y2="15"></line></svg>
                            <div class="text-center">
                                <p class="font-semibold text-lg text-[var(--text-primary)]"><span class="text-[var(--accent-burnt-umber)] font-bold">Click to upload</span> or drag and drop</p>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">PNG, JPG up to 10MB</p>
                            </div>
                            <input id="image" name="image" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" type="file" accept="image/*" required />
                            <div id="file-info" class="hidden mt-2 text-sm text-[var(--accent-sage)] font-medium"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6 mt-6">
                        <div>
                            <label for="description" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Artwork Description</label>
                            <textarea name="description" id="description" rows="3" class="form-input flex w-full rounded-md text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-golden-hour)] border border-[var(--border-color)] bg-[var(--background)] placeholder:text-[var(--text-secondary)] p-4 text-sm resize-none" placeholder="Describe what's in your artwork (e.g., 'Hand-painted traditional clay pot with intricate patterns' or 'Wooden sculpture of an elephant carved from teak')" required></textarea>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This helps the AI understand your artwork to create a meaningful story.</p>
                        </div>
                        <div>
                            <label for="storyType" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Story Style & Cultural Context</label>
                            <textarea name="storyType" id="storyType" rows="3" class="form-input flex w-full rounded-md text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-golden-hour)] border border-[var(--border-color)] bg-[var(--background)] placeholder:text-[var(--text-secondary)] p-4 text-sm resize-none" placeholder="Describe the cultural style and context for your story (e.g., 'The story should be leaned towards Indian culture with traditional values' or 'Tell it in the style of ancient folklore with mystical elements')"></textarea>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This will guide the AI to generate a story that matches your desired cultural context and storytelling style.</p>
                        </div>
                        <div>
                            <label for="productLink" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Product Purchase Link (Optional)</label>
                            <input name="productLink" id="productLink" type="url" class="form-input flex w-full rounded-md text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-golden-hour)] border border-[var(--border-color)] bg-[var(--background)] placeholder:text-[var(--text-secondary)] p-4 text-sm" placeholder="https://www.amazon.in/your-product-link or https://your-store.com/product" />
                            <p class="text-xs text-[var(--text-secondary)] mt-1">Add a link where viewers can purchase this artwork or similar items. A "Buy Now" button will appear on your story page.</p>
                        </div>
                    </div>
                    <div class="mt-8">
                        <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-3 bg-[var(--accent-golden-hour)] text-[var(--text-primary)] font-bold text-base rounded-lg shadow-sm hover:bg-opacity-90 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-golden-hour)]">Generate ArTale</button>
                    </div>
                </form>
            </div>
        </main>
        <footer class="bg-white/50 border-t border-[var(--border-color)] mt-auto py-6 px-10">
            <div class="container mx-auto text-center text-sm text-[var(--text-secondary)]">
                <p>Â© 2025 ArTales. All rights reserved.</p>
                <p class="mt-2">Celebrating the beauty of imperfection.</p>
            </div>
        </footer>
    </div>

</body>

<script>
    (async function () {
        // Check authentication first
        try {
            const res = await fetch('/api/me', { credentials: 'include' });
            if (!res.ok) {
                window.location.href = '/login.html';
                return;
            }
            // Show logout button if authenticated
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.classList.remove('hidden');
                logoutBtn.addEventListener('click', async () => {
                    await fetch('/api/logout', { method: 'POST', credentials: 'include' });
                    window.location.href = '/login.html';
                });
            }
        } catch (err) {
            window.location.href = '/login.html';
            return;
        }

        const form = document.getElementById('create-form');
        if (!form) return;
        
        // Handle file selection feedback
        const fileInput = document.getElementById('image');
        const fileInfo = document.getElementById('file-info');
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                fileInfo.classList.remove('hidden');
            } else {
                fileInfo.classList.add('hidden');
            }
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Generating Story...';
            submitBtn.disabled = true;
            
            const fd = new FormData(form);
            
            // Validate required fields
            if (!fd.get('image') || fd.get('image').size === 0) {
                alert('Please select an image to upload');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            if (!fd.get('description') || !fd.get('description').trim()) {
                alert('Please provide a description');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            // Default story type if empty
            if (!fd.get('storyType') || !fd.get('storyType').trim()) {
                fd.set('storyType', 'The story should be leaned towards Indian culture with traditional values and storytelling elements that celebrate craftsmanship and artistry');
            }
            
            try {
                const res = await fetch('/api/posts', { 
                    method: 'POST', 
                    body: fd, 
                    credentials: 'include' 
                });
                
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.error || 'Failed to create post');
                }
                
                const data = await res.json();
                window.location.href = '/story.html?id=' + data.id;
            } catch (err) {
                alert(err.message || 'Something went wrong');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
    })();
</script>

</html>